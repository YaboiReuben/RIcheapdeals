<!DOCTYPE null>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reubens and Isaacs Cheap Deals</title>
    <link rel="icon" type="image/png" href="favicon.png.png">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font import for a modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Light slate background */
        }
        /* Style for the cheap deal tag */
        .deal-tag {
            background-color: #ef4444; /* Red-500 */
            color: white;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 9999px; /* Fully rounded */
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Custom CSS for the discount toggle switch */
        .toggle-checkbox {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
        }
        .toggle-label {
            display: block;
            overflow: hidden;
            cursor: pointer;
            height: 24px;
            border-radius: 9999px;
            background-color: #d1d5db; /* Gray-300 */
            transition: background-color 0.2s ease;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5; /* Indigo-600 */
        }
        .toggle-checkbox + .toggle-label:before {
            content: "";
            display: block;
            width: 1.5rem;
            height: 1.5rem;
            background-color: #ffffff;
            border-radius: 50%;
            position: absolute;
            top: 0px;
            left: 0px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }
        .toggle-checkbox:checked + .toggle-label:before {
            transform: translateX(16px); /* Move 16px to the right for 40px width */
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen">
        <!-- Content will be rendered here by JavaScript -->
        <div class="flex justify-center items-center h-screen">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                <p class="mt-4 text-gray-600">Loading application...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, onSnapshot, collection, query, serverTimestamp, deleteDoc, setDoc, Timestamp, setLogLevel, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables are automatically provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Custom Firebase configuration for Firestore (Data) - Original
        const firestoreConfig = {
            apiKey: "AIzaSyAUm_0COJpzRzoRd-ELwZIAtNSaglzoIfU",
            authDomain: "raicd-e94ed.firebaseapp.com",
            projectId: "raicd-e94ed",
            storageBucket: "raicd-e94ed.firebasestorage.app",
            messagingSenderId: "708040718408",
            appId: "1:708040718408:web:bff0afb9098f58dce5807d",
            measurementId: "G-KX2FDWYH0X"
        };
        
        // Custom Firebase configuration for Authentication (Login Only) - NEW
        const authConfig = {
            apiKey: "AIzaSyAjKck807SLAcjYug5C-HtIsxeLJJVRA1g",
            authDomain: "ricd-login.firebaseapp.com",
            projectId: "ricd-login",
            storageBucket: "ricd-login.firebasestorage.app",
            messagingSenderId: "440300061854",
            appId: "1:440300061854:web:ef90b7c3ab147d8942278f",
            measurementId: "G-ZHK5S2DKKY"
        };
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Discord Webhook URL for order notifications (User provided)
        const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1440606078403612703/pGpNDVwEymNgxxUoAhFdZmDwT7M8pTPgnBLrGfLzoRz_soS1j7W1dkkS2IfkbyaFEHroq8ab";

        // --- Initialization ---
        setLogLevel('Debug');
        
        // Initialize two separate Firebase apps
        const firestoreApp = initializeApp(firestoreConfig, "firestoreApp");
        const authApp = initializeApp(authConfig, "authApp");
        
        const db = getFirestore(firestoreApp);
        let auth = null; 

        // --- Global State ---
        let state = {
            userId: null,
            isAuthReady: false,
            isStaff: false,
            products: [],
            currentView: 'public', // 'public', 'staff-login', 'staff-panel', 'checkout', 'order-success'
            loading: false,
            cart: [], // Stores { product: {id, name, price, stockQuantity}, quantity: 1 }
            rawLoadedCart: [], // Temporary storage for cart items loaded from Firestore (ID/Quantity only)
            isCartLoaded: false, // Flag to ensure we don't reconcile before cart is loaded
            errorMessage: null,
            successMessage: null,
            stockNotificationMessage: null // For stock reconciliation messages
        };

        const staffCredentials = {
            email: "staff@reubens.com",
            password: "secret"
        };

        // --- Utility Functions ---
        
        /**
         * Safely parse a value to an integer.
         * @param {string} value 
         * @returns {number | null}
         */
        function safeParseInt(value) {
            const num = parseInt(value, 10);
            return isNaN(num) ? null : num;
        }

        /**
         * Safely parse a value to a number.
         * @param {string} value 
         * @returns {number | null}
         */
        function safeParseFloat(value) {
            const num = parseFloat(value);
            return isNaN(num) ? null : num;
        }

        /**
         * Formats a number to currency string.
         * @param {number} amount 
         * @returns {string}
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
            }).format(amount);
        }
        
        /**
         * Calculates and formats the total price of items in the cart.
         * @returns {string}
         */
        function formatCartTotal() {
            const total = state.cart.reduce((sum, item) => sum + (item.product.price || 0) * item.quantity, 0);
            return formatCurrency(total);
        }
        
        /**
         * Clears all system messages.
         */
        function clearMessages() {
            state.errorMessage = null;
            state.successMessage = null;
            state.stockNotificationMessage = null;
        }

        // --- Firebase & Auth Setup ---

        // 1. Initial Authentication
        async function initializeAuth() {
            // Get auth instance from the dedicated authApp
            auth = getAuth(authApp);

            // 2. Auth State Listener setup
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    state.userId = user.uid;
                } else {
                    // If user somehow signs out, use a random ID as fallback for anonymous data.
                    state.userId = crypto.randomUUID(); 
                    state.isStaff = false; // Ensure staff status is revoked on auth change
                }
                // Set auth ready state here, regardless of success, to unblock the UI
                state.isAuthReady = true; 

                // NEW: Load cart right after user is identified
                if (!state.isCartLoaded) { 
                    loadCartFromFirestore();
                }

                fetchProducts();
                renderApp();
            });


            // 3. Attempt initial sign-in
            if (!authConfig.apiKey || !authConfig.authDomain) {
                console.error("Firebase Auth initialization skipped: apiKey or authDomain missing from auth config.");
                return;
            }

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error (Initial Attempt):", error); 
            }
        }

        // --- Firestore Cart Persistence ---

        /**
         * Returns the Firestore document reference for the current user's cart.
         */
        function getCartDocRef() {
            const userId = auth.currentUser?.uid || state.userId; // Use authenticated UID if available
            if (!userId || !db) return null;
            // Private user path: artifacts/{appId}/users/{userId}/cart/currentCart
            return doc(db, `artifacts/${appId}/users/${userId}/cart`, 'currentCart');
        }

        /**
         * Saves the current cart to Firestore with debounce.
         */
        let saveCartTimeout;
        function saveCartToFirestore() {
            clearTimeout(saveCartTimeout);
            saveCartTimeout = setTimeout(async () => {
                const cartRef = getCartDocRef();
                if (!cartRef) return;

                // Simplify cart data for storage: only ID and quantity needed
                const cartData = state.cart.map(item => ({
                    productId: item.product.id,
                    quantity: item.quantity
                }));

                try {
                    // Use setDoc to replace the entire cart data in the document
                    await setDoc(cartRef, { items: cartData, lastUpdated: serverTimestamp() }, { merge: false });
                    console.log("Cart saved to Firestore successfully.");
                } catch (error) {
                    console.error("Error saving cart to Firestore:", error);
                }
            }, 500); // Debounce for 500ms
        }

        /**
         * Loads the user's cart from Firestore upon app startup.
         */
        async function loadCartFromFirestore() {
            const cartRef = getCartDocRef();
            if (!cartRef) {
                state.isCartLoaded = true;
                renderApp();
                return;
            }

            try {
                const cartDoc = await getDoc(cartRef);
                if (cartDoc.exists()) {
                    const data = cartDoc.data();
                    if (data.items && Array.isArray(data.items)) {
                        state.rawLoadedCart = data.items; 
                        console.log(`Loaded ${data.items.length} raw items from cart document.`);
                    }
                }
            } catch (error) {
                console.error("Error loading cart from Firestore:", error);
            } finally {
                state.isCartLoaded = true;
                renderApp();
            }
        }

        /**
         * Reconciles the cart (loaded or current) against the latest public product stock.
         * @param {Array} products - Latest public product data.
         * @param {Array} currentCart - Current cart state.
         * @param {Array} rawLoadedCart - Cart items loaded from storage (ID/Qty only).
         * @returns {{updatedCart: Array, notificationMessages: Array}}
         */
        function reconcileCart(products, currentCart, rawLoadedCart) {
            let updatedCart = [];
            let notificationMessages = [];
            let cartToProcess = currentCart; 

            // 1. If we just loaded raw data, use it to initialize the cart
            if (rawLoadedCart && rawLoadedCart.length > 0) {
                cartToProcess = rawLoadedCart.map(rawItem => {
                    const product = products.find(p => p.id === rawItem.productId);
                    if (product) {
                        return { 
                            product: {
                                id: product.id,
                                name: product.name,
                                price: product.price,
                                stockQuantity: product.stockQuantity
                            },
                            quantity: rawItem.quantity
                        };
                    }
                    // Item no longer exists in the public list
                    notificationMessages.push(`The item with ID **${rawItem.productId.substring(0, 6)}...** was removed from the shop.`);
                    return null;
                }).filter(item => item !== null);
            }
            
            // 2. Run reconciliation on the cartToProcess
            cartToProcess.forEach(item => {
                const currentProduct = products.find(p => p.id === item.product.id);

                if (!currentProduct) {
                    notificationMessages.push(`"${item.product.name}" was removed from the shop and your cart.`);
                    return; 
                }

                const maxStock = currentProduct.stockQuantity;
                let finalQuantity = item.quantity;
                
                // A. Out of Stock check (stock <= 0)
                if (maxStock <= 0) {
                    notificationMessages.push(`"${item.product.name}" is now **SOLD OUT** and has been removed from your cart.`);
                    return; // Don't add to updatedCart
                }

                // B. Low Stock check (requested quantity > current stock)
                if (item.quantity > maxStock) {
                    finalQuantity = maxStock;
                    notificationMessages.push(`The quantity for **${item.product.name}** was reduced from ${item.quantity} to ${maxStock} due to **LOW STOCK**.`);
                }
                
                // C. Keep item, but update product details (price/stock)
                updatedCart.push({
                    quantity: finalQuantity,
                    product: {
                        id: currentProduct.id,
                        name: currentProduct.name,
                        price: currentProduct.price,
                        stockQuantity: currentProduct.stockQuantity
                    }
                });
            });

            return { updatedCart, notificationMessages };
        }
        
        // --- Firestore Operations ---

        /**
         * Sets up the real-time listener for the public product list and handles cart reconciliation.
         */
        function fetchProducts() {
            if (!state.isAuthReady) return;

            // Use the full public data path
            const productCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
            const q = query(productCollectionRef);

            onSnapshot(q, (snapshot) => {
                const newProducts = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const dateAdded = data.dateAdded instanceof Timestamp ? data.dateAdded.toDate() : new Date();
                    newProducts.push({
                        id: doc.id,
                        ...data,
                        stockQuantity: safeParseInt(data.stockQuantity) || 0,
                        dateAdded: dateAdded
                    });
                });
                
                state.products = newProducts.sort((a, b) => b.dateAdded - a.dateAdded);
                
                // NEW: Cart Reconciliation and Synchronization
                // Only run reconciliation if we've attempted to load the cart
                if (state.isCartLoaded) {
                    const isNewLoad = state.rawLoadedCart.length > 0;
                    
                    const { updatedCart, notificationMessages } = reconcileCart(
                        state.products, 
                        state.cart, 
                        state.rawLoadedCart
                    );

                    if (notificationMessages.length > 0) {
                        // Display notification if cart was modified due to stock
                        state.stockNotificationMessage = notificationMessages.map(msg => `<li>${msg}</li>`).join('');
                    } else if (isNewLoad && updatedCart.length > 0) {
                        // Success message for a fresh load of a non-empty cart
                         state.stockNotificationMessage = `<li>Welcome back! Your cart with **${updatedCart.length} item(s)** has been loaded.</li>`;
                    } else {
                         state.stockNotificationMessage = null;
                    }

                    // Update cart state and persist the change
                    const cartChanged = JSON.stringify(updatedCart) !== JSON.stringify(state.cart);

                    if (cartChanged || isNewLoad) {
                         state.cart = updatedCart;
                         saveCartToFirestore(); // Persist the reconciled cart
                    }
                    
                    state.rawLoadedCart = []; // Clear raw data after processing
                }
                
                renderApp();
            }, (error) => {
                console.error("Error fetching products:", error);
                state.errorMessage = "Failed to load deals. Check console for details.";
                renderApp();
            });
        }

        /**
         * Adds a new product to Firestore.
         * @param {object} productData 
         */
        async function addProduct(productData) {
            if (!state.isStaff) {
                renderApp();
                return;
            }

            try {
                const productCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
                await addDoc(productCollectionRef, {
                    ...productData,
                    price: safeParseFloat(productData.price), 
                    originalPrice: safeParseFloat(productData.originalPrice),
                    stockQuantity: safeParseInt(productData.stockQuantity) || 0,
                    dateAdded: serverTimestamp(),
                    staffId: state.userId
                });
                state.successMessage = "New product added successfully!";
            } catch (error) {
                console.error("Error adding product:", error);
                state.errorMessage = "Failed to add product.";
            } finally {
                state.loading = false;
                renderApp();
            }
        }

        /**
         * Deletes a product from Firestore.
         * @param {string} productId 
         */
        async function deleteProduct(productId) {
            if (!state.isStaff) {
                renderApp();
                return;
            }
            state.loading = true;
            clearMessages();
            renderApp();

            try {
                const productDocRef = doc(db, `artifacts/${appId}/public/data/products`, productId);
                await deleteDoc(productDocRef);
                state.successMessage = "Product deleted successfully.";
            } catch (error) {
                console.error("Error deleting product:", error);
                state.errorMessage = "Failed to delete product.";
            } finally {
                state.loading = false;
                renderApp();
            }
        }

        // --- Event Handlers & View Switching ---

        function handleStaffLogin(e) {
            e.preventDefault();
            state.loading = true;
            clearMessages();
            renderApp();

            const form = e.target;
            const email = form.email.value;
            const password = form.password.value;

            if (email === staffCredentials.email && password === staffCredentials.password) {
                state.isStaff = true;
                state.currentView = 'staff-panel';
                state.successMessage = "Staff login successful!";
            } else {
                state.errorMessage = "Invalid Staff Credentials.";
            }

            state.loading = false;
            renderApp();
        }

        function handleStaffLogout() {
            if (auth) {
                signOut(auth).catch(e => console.error("Sign out failed:", e));
            }
            state.isStaff = false;
            state.currentView = 'public';
            clearMessages();
            state.successMessage = "Logged out successfully.";
            renderApp();
        }

        /**
         * Toggles the visibility of the discounted price input in the staff panel.
         * @param {Event} e 
         */
        function handleDiscountToggle(e) {
            const isChecked = e.target.checked;
            const container = document.getElementById('discount-price-container');
            const discountInput = document.getElementById('discountPrice');

            if (container && discountInput) {
                if (isChecked) {
                    container.classList.remove('hidden');
                    discountInput.setAttribute('required', 'required');
                } else {
                    container.classList.add('hidden');
                    discountInput.removeAttribute('required');
                    discountInput.value = ''; // Clear value when hidden
                }
            }
        }

        function handleProductAdd(e) {
            e.preventDefault();
            if (state.loading) return;
            clearMessages();

            const form = e.target;
            const name = form.name.value.trim();
            const originalPriceRaw = form.originalPrice.value;
            const isDiscountActive = form.discountActive.checked;
            const discountPriceRaw = form.discountPrice?.value || originalPriceRaw; 
            const description = form.description.value.trim();
            const stockQuantityRaw = form.stockQuantity.value; 
            
            // --- Validation ---
            if (!name || !originalPriceRaw || !description || !stockQuantityRaw) {
                state.errorMessage = "Validation failed: All fields are required.";
                renderApp();
                return;
            }

            const originalPrice = safeParseFloat(originalPriceRaw);
            let dealPrice = originalPrice; 
            const stockQuantity = safeParseInt(stockQuantityRaw); 

            if (originalPrice === null) {
                 state.errorMessage = "Validation failed: Original Price must be a valid number.";
                 renderApp();
                 return;
            }

            if (stockQuantity === null || stockQuantity < 0) {
                 state.errorMessage = "Validation failed: Stock Quantity must be a non-negative integer.";
                 renderApp();
                 return;
            }

            if (isDiscountActive) {
                const discountPrice = safeParseFloat(discountPriceRaw);
                
                if (discountPrice === null) {
                    state.errorMessage = "Validation failed: Discounted Price must be a valid number when discount is active.";
                    renderApp();
                    return;
                }
                
                if (discountPrice >= originalPrice) {
                    state.errorMessage = "Validation failed: Discounted Price must be less than the Original Price.";
                    renderApp();
                    return;
                }
                
                dealPrice = discountPrice;
            }

            state.loading = true;
            renderApp();

            addProduct({ name, price: dealPrice, originalPrice: originalPrice, stockQuantity: stockQuantity, description })
                .then(() => {
                    // Reset form on success
                    form.reset();
                    // Manually reset discount UI state after form reset
                    const container = document.getElementById('discount-price-container');
                    const discountInput = document.getElementById('discountPrice');
                    const discountSwitch = document.getElementById('discountActive');
                    if (container) container.classList.add('hidden');
                    if (discountInput) discountInput.removeAttribute('required');
                    if (discountSwitch) discountSwitch.checked = false;
                });
        }
        
        /**
         * Adds a product to the cart or increments its quantity.
         * @param {string} productId 
         */
        function handleAddToCart(productId) {
            clearMessages();
            const product = state.products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = state.cart.find(item => item.product.id === productId);
            const currentQuantityInCart = existingItem ? existingItem.quantity : 0;
            const maxQuantity = product.stockQuantity;

            if (currentQuantityInCart >= maxQuantity) {
                 state.errorMessage = `Cannot add more ${product.name}. Max stock (${maxQuantity}) reached.`;
                 renderApp();
                 return;
            }

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                // Store essential product info, including current stock for cart reconciliation
                const cartProduct = {
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    stockQuantity: product.stockQuantity 
                };
                state.cart.push({ product: cartProduct, quantity: 1 });
            }

            // NEW: Save cart to Firestore after every modification
            saveCartToFirestore();

            state.successMessage = `${product.name} added to cart!`;
            renderApp();
        }

        /**
         * Removes an item from the cart.
         * @param {string} productId 
         */
        function handleRemoveFromCart(productId) {
            state.cart = state.cart.filter(item => item.product.id !== productId);
            saveCartToFirestore();
            clearMessages();
            state.successMessage = "Item removed from cart.";
            renderApp();
        }


        /**
         * Handles the checkout form submission, runs stock transaction, sends webhook, and saves the order to Firestore.
         * @param {Event} e 
         */
        async function handleCheckoutSubmit(e) {
            e.preventDefault();
            if (state.loading || state.cart.length === 0) return;

            state.loading = true;
            clearMessages();
            renderApp();

            const form = e.target;
            const fullName = form.fullName.value.trim();
            const email = form.email.value.trim();
            const total = formatCartTotal();

            if (!fullName || !email) {
                state.errorMessage = "Checkout failed: Full Name and Email are required.";
                state.loading = false;
                renderApp();
                return;
            }

            // --- 1. ATOMIC STOCK CHECK AND DECREMENT (TRANSACTION) ---
            try {
                await runTransaction(db, async (transaction) => {
                    for (const item of state.cart) {
                        const productRef = doc(db, `artifacts/${appId}/public/data/products`, item.product.id);
                        const productDoc = await transaction.get(productRef);

                        if (!productDoc.exists()) {
                            throw new Error(`Product not found: ${item.product.name}`);
                        }
                        
                        const currentStock = safeParseInt(productDoc.data().stockQuantity) || 0;
                        const quantityRequested = item.quantity;
                        
                        if (currentStock < quantityRequested) {
                            // Abort transaction and throw a specific error
                            throw new Error(`INSUFFICIENT STOCK: Only ${currentStock} of "${item.product.name}" left, but you requested ${quantityRequested}.`);
                        }
                        
                        // Decrement stock
                        const newStock = currentStock - quantityRequested;
                        transaction.update(productRef, { stockQuantity: newStock });
                    }
                });

                // --- 2. IF TRANSACTION SUCCEEDS, PROCEED WITH ORDER FULFILLMENT ---
                
                const orderDetails = {
                    fullName: fullName,
                    email: email,
                    paymentMethod: "Cash only",
                    items: state.cart.map(item => ({
                        id: item.product.id,
                        name: item.product.name,
                        price: item.product.price,
                        quantity: item.quantity
                    })),
                    totalAmount: total,
                    dateSubmitted: new Date().toISOString(),
                    userId: state.userId
                };
                
                // --- Discord Webhook Notification ---
                const webhookPayload = {
                    username: "R&I Cheap Deals Bot",
                    avatar_url: "https://placehold.co/64x64/4f46e5/ffffff?text=CD",
                    embeds: [{
                        title: "üõí NEW CHEAP DEAL ORDER PLACED!",
                        color: 3447003,
                        fields: [
                            { name: "üë§ Customer Name", value: orderDetails.fullName, inline: true },
                            { name: "üìß Email", value: orderDetails.email, inline: true },
                            { name: "üí∞ Total Amount", value: orderDetails.totalAmount, inline: true },
                            { name: "Date/Time", value: `<t:${Math.floor(Date.now() / 1000)}:f>`, inline: true },
                            { name: "User ID", value: state.userId, inline: false },
                            { name: "Items", value: orderDetails.items.map(i => 
                                `‚Ä¢ ${i.name} (x${i.quantity}) - ${formatCurrency(i.price * i.quantity)}`
                            ).join('\n'), inline: false }
                        ],
                        footer: {
                            text: `Order submitted for App ID: ${appId}`
                        }
                    }]
                };

                try {
                    await fetch(DISCORD_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(webhookPayload)
                    });
                    console.log("Discord webhook notified successfully.");
                } catch (error) {
                    console.error("Error sending Discord notification (non-critical):", error);
                }

                // --- Save Order to Firestore ---
                const orderCollectionRef = collection(db, `artifacts/${appId}/public/data/orders`);
                const firestoreOrderData = {
                    ...orderDetails,
                    dateSubmitted: serverTimestamp(),
                };
                await addDoc(orderCollectionRef, firestoreOrderData);

                // --- 3. FINAL SUCCESS ---
                state.currentView = 'order-success'; 
                state.cart = [];
                saveCartToFirestore(); // Save empty cart after success
                form.reset();
                
            } catch (error) {
                // --- 4. TRANSACTION FAILURE (STOCK ISSUE OR OTHER ERROR) ---
                console.error("Order process aborted:", error);
                
                if (error.message.includes("INSUFFICIENT STOCK")) {
                    state.errorMessage = `Order failed: ${error.message}. Please adjust your cart and try again.`;
                } else {
                    state.errorMessage = "Order failed due to a processing error. Please try again.";
                }
                
                // Do NOT clear cart. The user is returned to the checkout page with the cart intact.
            } finally {
                state.loading = false;
                renderApp();
            }
        }


        // --- Rendering Components ---
        
        /**
         * Renders system messages (errors/success/stock) at the top of the app.
         */
        function renderMessages() {
            let messageHtml = '';
            
            // 1. Prioritize Stock Notifications
            if (state.stockNotificationMessage) {
                messageHtml = `
                    <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-lg shadow-lg mb-4 flex justify-between items-start" role="alert">
                        <div class="flex-grow">
                            <strong class="font-bold block mb-1">Stock and Cart Update:</strong>
                            <ul class="text-sm list-disc pl-5">${state.stockNotificationMessage}</ul>
                        </div>
                        <button class="ml-4 text-yellow-500 hover:text-yellow-700 mt-1" onclick="window.clearMessages(); window.renderApp();">
                            <svg class="h-6 w-6" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.166l-2.651 3.683a1.2 1.2 0 0 1-1.697-1.697l3.683-2.651-3.683-2.651a1.2 1.2 0 0 1 1.697-1.697l2.651 3.683 2.651-3.683a1.2 1.2 0 0 1 1.697 1.697l-3.683 2.651 3.683 2.651a1.2 1.2 0 0 1 0 1.697z"/></svg>
                        </button>
                    </div>
                `;
            } 
            // 2. Error message logic
            else if (state.errorMessage) {
                messageHtml = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg mb-4 flex justify-between items-center" role="alert">
                        <strong class="font-bold mr-2">Error:</strong>
                        <span class="block sm:inline flex-grow">${state.errorMessage}</span>
                        <button class="ml-4 text-red-500 hover:text-red-700" onclick="window.clearMessages(); window.renderApp();">
                            <svg class="h-6 w-6" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.166l-2.651 3.683a1.2 1.2 0 0 1-1.697-1.697l3.683-2.651-3.683-2.651a1.2 1.2 0 0 1 1.697-1.697l2.651 3.683 2.651-3.683a1.2 1.2 0 0 1 1.697 1.697l-3.683 2.651 3.683 2.651a1.2 1.2 0 0 1 0 1.697z"/></svg>
                        </button>
                    </div>
                `;
            } 
            // 3. Success message logic
            else if (state.successMessage) {
                 messageHtml = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg mb-4 flex justify-between items-center" role="alert">
                        <strong class="font-bold mr-2">Success:</strong>
                        <span class="block sm:inline flex-grow">${state.successMessage}</span>
                        <button class="ml-4 text-green-500 hover:text-green-700" onclick="window.clearMessages(); window.renderApp();">
                            <svg class="h-6 w-6" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.166l-2.651 3.683a1.2 1.2 0 0 1-1.697-1.697l3.683-2.651-3.683-2.651a1.2 1.2 0 0 1 1.697-1.697l2.651 3.683 2.651-3.683a1.2 1.2 0 0 1 1.697 1.697l-3.683 2.651 3.683 2.651a1.2 1.2 0 0 1 0 1.697z"/></svg>
                        </button>
                    </div>
                `;
            }
            return messageHtml;
        }

        /**
         * Renders the navigation bar.
         */
        function renderNavbar() {
            const cartItemCount = state.cart.reduce((total, item) => total + item.quantity, 0);
            return `
                <header class="bg-white shadow-lg sticky top-0 z-20">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                        <h1 class="text-3xl font-extrabold text-indigo-700 cursor-pointer" onclick="window.state.currentView = 'public'; window.renderApp();">
                            R&I Cheap Deals
                        </h1>
                        <nav class="flex space-x-4 items-center">
                            
                            <!-- Checkout Button -->
                            <button onclick="window.state.currentView = 'checkout'; window.renderApp();" 
                                class="relative bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition duration-150 shadow-md flex items-center">
                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                Checkout
                                <span class="ml-2 bg-white text-red-600 text-xs font-extrabold px-2 py-0.5 rounded-full">${cartItemCount}</span>
                            </button>
                            
                            ${state.isStaff ? `
                                <span class="text-xs font-semibold text-green-600 bg-green-100 px-3 py-1 rounded-full hidden sm:inline">Staff ID: ${state.userId.substring(0, 8)}...</span>
                                <button onclick="window.state.currentView = 'staff-panel'; window.renderApp();" 
                                    class="bg-indigo-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition duration-150 shadow-md">
                                    Staff Panel
                                </button>
                                <button onclick="window.handleStaffLogout();" 
                                    class="text-gray-500 hover:text-indigo-600 transition duration-150 text-sm">
                                    Logout
                                </button>
                            ` : `
                                <button onclick="window.state.currentView = 'staff-login'; window.renderApp();" 
                                    class="text-indigo-600 border border-indigo-600 px-3 py-2 rounded-lg text-sm font-medium hover:bg-indigo-50 transition duration-150 shadow-sm">
                                    Staff Login
                                </button>
                            `}
                        </nav>
                    </div>
                </header>
            `;
        }

        /**
         * Renders the main product list view.
         */
        function renderPublicDeals() {
            const productCards = state.products.length > 0
                ? state.products.map(p => {
                    // UPDATED: Show exact stock quantity for all non-sold-out items
                    const stock = p.stockQuantity;
                    const isOutOfStock = stock <= 0;
                    
                    let stockStatus = 'Sold Out';
                    let stockClass = 'text-red-600';

                    if (stock > 0) {
                        stockStatus = `Stock: ${stock} left`;
                        if (stock > 5) {
                            stockClass = 'text-green-600'; // High/Normal Stock
                        } else {
                            stockClass = 'text-yellow-600'; // Low Stock Alert
                        }
                    }

                    return `
                    <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 flex flex-col">
                        <div class="flex items-start justify-between mb-4">
                            ${p.price < p.originalPrice ? '<span class="deal-tag">Cheap Deal!</span>' : ''}
                            <span class="text-sm text-gray-400">Added: ${p.dateAdded.toLocaleDateString()}</span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">${p.name}</h2>
                        <p class="text-gray-600 mb-4 flex-grow">${p.description}</p>
                        <div class="mt-auto">
                            <div class="flex items-baseline space-x-3">
                                <span class="text-4xl font-extrabold text-red-600">${formatCurrency(p.price)}</span>
                                ${p.price < p.originalPrice ? `<span class="text-lg text-gray-400 line-through">${formatCurrency(p.originalPrice)}</span>` : ''}
                            </div>
                            ${p.price < p.originalPrice ? 
                                `<p class="text-sm text-green-600 mt-3 font-semibold mb-4">${Math.round(((p.originalPrice - p.price) / p.originalPrice) * 100)}% SAVINGS!</p>` : 
                                `<p class="text-sm text-gray-500 mt-3 font-semibold mb-4">Full Price</p>`}
                            
                            <!-- Stock Status -->
                            <p class="text-sm font-semibold mb-4 ${stockClass}">
                                ${stockStatus}
                            </p>


                            <!-- Add to Cart Button (disabled if out of stock) -->
                            <button onclick="window.handleAddToCart('${p.id}');"
                                ${isOutOfStock ? 'disabled' : ''}
                                class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md flex items-center justify-center disabled:bg-gray-400">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                                ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                            </button>
                        </div>
                    </div>
                `;
                }).join('')
                : `
                    <div class="md:col-span-3 text-center py-12 bg-white rounded-xl shadow-inner">
                        <p class="text-xl text-gray-500 font-medium">No cheap deals available right now. Check back soon!</p>
                    </div>
                `;

            return `
                <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                    <h2 class="text-4xl font-bold text-gray-800 mb-8 text-center sm:text-left">Today's Hottest Deals üî•</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${productCards}
                    </div>
                </main>
            `;
        }
        
        /**
         * Renders the staff login form.
         */
        function renderStaffLogin() {
            return `
                <main class="max-w-md mx-auto p-6 mt-16">
                    <div class="bg-white p-8 rounded-xl shadow-2xl">
                        <h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">Staff Login</h2>
                        <form id="staff-login-form" onsubmit="window.handleStaffLogin(event)">
                            <div class="mb-4">
                                <label for="email" class="block text-gray-700 font-medium mb-2">Email</label>
                                <input type="email" id="email" name="email" required 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-gray-700 font-medium mb-2">Password</label>
                                <input type="password" id="password" name="password" required 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                            </div>
                            <button type="submit" ${state.loading ? 'disabled' : ''}
                                class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-400 shadow-md">
                                ${state.loading ? 'Logging In...' : 'Log In'}
                            </button>
                        </form>
                    </div>
                </main>
            `;
        }

        /**
         * Renders the staff panel for adding and deleting products.
         */
        function renderStaffPanel() {
            const productList = state.products.map(p => `
                <li class="flex justify-between items-center bg-gray-50 p-4 rounded-lg shadow-sm mb-2">
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">${p.name} 
                            ${p.price < p.originalPrice ? `<span class="text-sm text-red-600">(${formatCurrency(p.price)} DEAL)</span>` : `<span class="text-sm text-gray-600">(${formatCurrency(p.price)})</span>`}
                        </p>
                        <!-- UPDATED: Display Stock Quantity -->
                        <p class="text-xs text-gray-500">
                            <span class="${p.stockQuantity > 5 ? 'text-green-600' : (p.stockQuantity > 0 ? 'text-yellow-600' : 'text-red-600')} font-bold">Stock: ${p.stockQuantity || 0}</span> | Original: ${formatCurrency(p.originalPrice)} | ID: ${p.id.substring(0, 6)}...
                        </p>
                    </div>
                    <button onclick="window.deleteProduct('${p.id}');" ${state.loading ? 'disabled' : ''}
                        class="ml-4 bg-red-500 text-white p-2 rounded-lg text-sm hover:bg-red-600 transition disabled:bg-gray-400">
                        ${state.loading ? 'Wait' : 'Delete'}
                    </button>
                </li>
            `).join('');

            return `
                <main class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
                    <h2 class="text-4xl font-bold text-gray-800 mb-8">Staff Control Panel üõ†Ô∏è</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Add New Deal Form -->
                        <div class="bg-white p-6 rounded-xl shadow-2xl h-fit">
                            <h3 class="text-2xl font-semibold text-indigo-700 mb-4 border-b pb-2">Add New Cheap Deal</h3>
                            <form id="add-product-form" onsubmit="window.handleProductAdd(event)">
                                <div class="mb-4">
                                    <label for="name" class="block text-gray-700 font-medium mb-1">Product Name</label>
                                    <input type="text" id="name" name="name" required 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                
                                <!-- Original Price Input (Always required) -->
                                <div class="mb-4">
                                    <label for="originalPrice" class="block text-gray-700 font-medium mb-1">Original Price ($)</label>
                                    <input type="number" step="0.01" id="originalPrice" name="originalPrice" required 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                
                                <!-- Stock Quantity Input (NEW) -->
                                <div class="mb-4">
                                    <label for="stockQuantity" class="block text-gray-700 font-medium mb-1">Stock Quantity</label>
                                    <input type="number" step="1" min="0" id="stockQuantity" name="stockQuantity" required value="10"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                </div>

                                <!-- Discount Switch -->
                                <div class="flex items-center justify-between mb-4 p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                                    <label for="discountActive" class="text-gray-700 font-medium flex items-center">
                                        <svg class="w-5 h-5 mr-2 text-indigo-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-7-9a1 1 0 000 2h14a1 1 0 100-2H3z" clip-rule="evenodd"></path></svg>
                                        Apply Discount?
                                    </label>
                                    <div class="relative w-10 select-none">
                                        <input type="checkbox" name="discountActive" id="discountActive" class="toggle-checkbox" onclick="window.handleDiscountToggle(event)">
                                        <label for="discountActive" class="toggle-label"></label>
                                    </div>
                                </div>

                                <!-- Discounted Price Input (Initially Hidden) -->
                                <div id="discount-price-container" class="mb-6 hidden">
                                    <label for="discountPrice" class="block text-gray-700 font-medium mb-1 text-green-700">Discounted Price ($)</label>
                                    <input type="number" step="0.01" id="discountPrice" name="discountPrice" 
                                        class="w-full px-4 py-2 border border-green-400 rounded-lg focus:ring-green-500 focus:border-green-500 bg-green-50">
                                    <p class="text-xs text-gray-500 mt-1">This must be lower than the Original Price.</p>
                                </div>


                                <div class="mb-6">
                                    <label for="description" class="block text-gray-700 font-medium mb-1">Description</label>
                                    <textarea id="description" name="description" rows="3" required 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                                </div>
                                <button type="submit" ${state.loading ? 'disabled' : ''}
                                    class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition disabled:bg-green-400 shadow-md">
                                    ${state.loading ? 'Adding...' : 'Add Deal to Shop'}
                                </button>
                            </form>
                        </div>
                        
                        <!-- Current Deals List -->
                        <div class="bg-white p-6 rounded-xl shadow-2xl">
                            <h3 class="text-2xl font-semibold text-indigo-700 mb-4 border-b pb-2">Currently Listed Deals (${state.products.length})</h3>
                            <ul class="max-h-[600px] overflow-y-auto pr-2">
                                ${productList.length > 0 ? productList : '<p class="text-gray-500 text-center py-4">No deals currently listed.</p>'}
                            </ul>
                            <p class="mt-4 text-xs text-gray-500 italic">User ID for uploads: ${state.userId}</p>
                        </div>
                    </div>
                </main>
            `;
        }

        /**
         * Renders the checkout order submission form.
         */
        function renderCheckoutForm() {
            if (state.cart.length === 0) {
                return `
                    <main class="max-w-xl mx-auto p-6 mt-16 bg-white rounded-xl shadow-2xl text-center">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Your Cart is Empty üõí</h2>
                        <p class="text-gray-600 mb-6">Please add some cheap deals before checking out!</p>
                        <button onclick="window.state.currentView = 'public'; window.renderApp();" 
                            class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
                            Continue Shopping
                        </button>
                    </main>
                `;
            }

            const cartItemsList = state.cart.map(item => `
                <li class="flex justify-between py-2 border-b border-gray-100 items-center">
                    <div>
                        <span class="text-gray-700 font-medium">${item.product.name} (x${item.quantity})</span>
                        <p class="text-xs ${item.product.stockQuantity <= item.quantity ? 'text-red-500 font-bold' : 'text-gray-500'}">
                            Stock Available: ${item.product.stockQuantity}
                        </p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-semibold">${formatCurrency(item.product.price * item.quantity)}</span>
                         <!-- NEW: Remove button -->
                        <button onclick="window.handleRemoveFromCart('${item.product.id}')"
                                class="text-red-500 hover:text-red-700 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </li>
            `).join('');


            return `
                <main class="max-w-xl mx-auto p-6 mt-16">
                    <div class="bg-white p-8 rounded-xl shadow-2xl">
                        <!-- New 'Go back to Deals' Button -->
                        <button onclick="window.state.currentView = 'public'; window.renderApp();" 
                            class="mb-4 text-indigo-600 font-medium hover:text-indigo-800 transition duration-150 flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            Go back to Deals
                        </button>

                        <h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">Checkout</h2>
                        
                        <div class="mb-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                             <h3 class="text-xl font-semibold text-indigo-700 mb-2">Order Summary</h3>
                             <ul class="mb-2">
                                ${cartItemsList}
                             </ul>
                             <div class="flex justify-between items-center pt-2 border-t border-indigo-200 mt-2">
                                <span class="text-lg font-bold text-gray-800">Total:</span>
                                <span class="text-2xl font-extrabold text-red-600">${formatCartTotal()}</span>
                             </div>
                        </div>

                        <form id="checkout-form" onsubmit="window.handleCheckoutSubmit(event)">
                            <div class="mb-4">
                                <label for="fullName" class="block text-gray-700 font-medium mb-2">Full Name</label>
                                <input type="text" id="fullName" name="fullName" required 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                            </div>
                            <div class="mb-6">
                                <label for="email" class="block text-gray-700 font-medium mb-2">Email Address</label>
                                <input type="email" id="email" name="email" required 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                            </div>
                            
                            <div class="mb-6 p-4 bg-yellow-100 rounded-lg border border-yellow-300">
                                <label class="block text-gray-700 font-bold mb-1">Payment Method</label>
                                <p class="text-lg font-extrabold text-yellow-800">Cash only</p>
                                <p class="text-sm text-yellow-700 mt-2 italic">Note: We will email you to confirm where to drop off the item.</p>
                            </div>

                            <button type="submit" ${state.loading ? 'disabled' : ''}
                                class="w-full bg-red-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-red-700 transition duration-150 disabled:bg-red-400 shadow-xl">
                                ${state.loading ? 'Submitting Order...' : 'Submit Order'}
                            </button>
                        </form>
                    </div>
                </main>
            `;
        }
        
        /**
         * Renders the order success message.
         */
        function renderOrderSuccess() {
            return `
                <main class="max-w-xl mx-auto p-6 mt-16 bg-white rounded-xl shadow-2xl text-center">
                    <svg class="w-20 h-20 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h2 class="text-3xl font-bold text-green-700 mb-4">Order Placed Successfully! üéâ</h2>
                    <p class="text-gray-600 mb-6 font-medium">
                        Your order has been submitted and stock has been reserved. Look out for an email from us with drop-off details!
                        <br><small class="text-gray-400 mt-2 block">Staff has been notified via Discord.</small>
                    </p>
                    <button onclick="window.state.currentView = 'public'; window.renderApp();" 
                        class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
                        Back to Deals
                    </button>
                </main>
            `;
        }


        /**
         * Renders the main application view based on the current state.
         */
        function renderApp() {
            const appDiv = document.getElementById('app');
            let contentHTML = '';

            if (!state.isAuthReady) {
                 appDiv.innerHTML = `
                    <div class="flex justify-center items-center h-screen">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                            <p class="mt-4 text-gray-600">Initializing Authentication...</p>
                        </div>
                    </div>
                `;
                return;
            }

            // 1. Render Navbar
            contentHTML += renderNavbar();
            
            // 2. Render Messages in a fixed container
            contentHTML += `
                <div class="fixed top-20 left-1/2 -translate-x-1/2 w-11/12 max-w-lg z-30">
                    ${renderMessages()}
                </div>
            `;

            // 3. Render Main Content based on view
            if (state.currentView === 'staff-login') {
                contentHTML += renderStaffLogin();
            } else if (state.currentView === 'staff-panel' && state.isStaff) {
                contentHTML += renderStaffPanel();
            } else if (state.currentView === 'checkout') {
                contentHTML += renderCheckoutForm();
            } else if (state.currentView === 'order-success') {
                contentHTML += renderOrderSuccess();
            } else {
                contentHTML += renderPublicDeals();
            }


            appDiv.innerHTML = contentHTML;
        }

        // Expose functions and state to global scope for inline event handlers
        window.state = state;
        window.renderApp = renderApp;
        window.handleStaffLogin = handleStaffLogin;
        window.handleStaffLogout = handleStaffLogout;
        window.handleProductAdd = handleProductAdd;
        window.deleteProduct = deleteProduct;
        window.handleAddToCart = handleAddToCart;
        window.handleRemoveFromCart = handleRemoveFromCart; // Exposed new function
        window.handleCheckoutSubmit = handleCheckoutSubmit;
        window.handleDiscountToggle = handleDiscountToggle;
        window.clearMessages = clearMessages;


        // Start the application
        initializeAuth();
    </script>
</body>
</html>
